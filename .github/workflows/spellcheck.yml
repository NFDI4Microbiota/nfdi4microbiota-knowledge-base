name: Spellcheck Action

on:
  push:
  workflow_dispatch:

jobs:
  spellcheck:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Get changed markdown files
      id: changed_files
      uses: tj-actions/changed-files@v46
      with:
        files: |
          **/*.md
          **/*.markdown

    - name: Format file list
      id: format_files
      run: |
        echo "files=$(echo \"${{ steps.changed_files.outputs.all_changed_files }}\" | tr '\n' ' ')" >> $GITHUB_OUTPUT

    - name: Run Spellcheck
      id: spellcheck
      uses: rojopolis/spellcheck-github-actions@v0
      with:
        task_name: Markdown
        config_path: .github/workflows/spellcheck_config.yml
        source_files: ${{ steps.changed_files.outputs.all_changed_files || '' }}
        output_file: spellcheck-output.txt

    - name: Find PR number
      if: '!cancelled()'
      id: find_pr
      uses: actions/github-script@v6
      with:
        script: |
          const prs = await github.rest.pulls.list({
            owner: context.repo.owner,
            repo: context.repo.repo,
            head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
            state: 'open'
          });

          if (prs.data.length === 0) {
            core.setFailed('No open PR found for this branch.');
          } else {
            const prNumber = prs.data[0].number;
            core.setOutput('pr', prNumber);
          }

    - name: Comment on PR
      if: steps.check_spelling.outputs.fail == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const output = fs.readFileSync('spellcheck-output.txt', 'utf8');
          await github.rest.issues.createComment({
            issue_number: ${{ steps.find_pr.outputs.pr }},
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `### üìù Spellcheck Report\n\`\`\`\n${output}\n\`\`\``
          });

#    - name: Check for spelling errors
#      if: '!cancelled()'
#      id: check_spelling
#      run: |
#        if [ -s spellcheck-output.txt ]; then
#          echo "Spelling issues found."
#          echo "fail=true" >> $GITHUB_OUTPUT
#        else
#          echo "No spelling issues."
#          echo "fail=false" >> $GITHUB_OUTPUT
#        fi

#    - name: Comment on PR with spellcheck result
#      if: '!cancelled()'
#      if: steps.check_spelling.outputs.fail == 'true'
#      uses: actions/github-script@v6
#      with:
#        script: |
#          const fs = require('fs');
#          const output = fs.readFileSync('spellcheck-output.txt', 'utf8');
#          github.rest.issues.createComment({
#            issue_number: context.issue.number,
#            owner: context.repo.owner,
#            repo: context.repo.repo,
#            body: `### üìù Spellcheck Report\n\`\`\`\n${output}\n\`\`\``
#          });
